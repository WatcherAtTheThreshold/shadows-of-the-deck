<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadows in the Deck - Enhanced</title>
<style>
  body { 
    font-family: sans-serif; 
    background: #111; 
    color: #eee; 
    text-align: center; 
    position: relative;
    overflow-x: hidden;
  }
  
  /* Animated mist overlay */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: -100%;
    width: 300%;
    height: 100%;
    background-image: url('images/mist-overlay.png');
    background-repeat: repeat-x;
    background-size: 100% 100%;
    opacity: 0.3;
    z-index: -1;
    animation: driftMist 20s linear infinite;
    transition: background-image 2s ease-in-out;
  }
  
  body.danger-mode::before {
    background-image: url('images/mist-overlay2.png');
    opacity: 0.5;
    animation-duration: 15s;
  }
  
  @keyframes driftMist {
    0% { transform: translateX(0); }
    100% { transform: translateX(100px); }
  }
  
  #game { max-width: 1000px; margin: auto; position: relative; z-index: 1; }
  #market, #player-hand { display: flex; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
  .card { 
    background: rgba(51, 51, 51, 0.9); 
    border: 2px solid #666; 
    border-radius: 8px; 
    width: 100px; 
    height: 140px; 
    margin: 5px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer;
    backdrop-filter: blur(5px);
    position: relative;
  }
  .card:hover { border-color: gold; transform: translateY(-2px); }
  .cost { font-size: 0.8em; color: gold; }
  
  #map { 
    display: flex; 
    justify-content: center; 
    margin: 20px 0; 
    flex-wrap: wrap;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .node { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    background: #555; 
    margin: 5px; 
    position: relative;
    cursor: help;
  }
  
  .player { 
    width: 20px; 
    height: 20px; 
    border-radius: 50%; 
    background: cyan; 
    position: absolute; 
    top: 10px; 
    left: 10px;
    box-shadow: 0 0 10px cyan;
  }
  
  .fragment { 
    width: 14px; 
    height: 14px; 
    border-radius: 50%; 
    background: gold; 
    position: absolute; 
    bottom: 3px; 
    right: 3px;
    box-shadow: 0 0 8px gold;
  }
  
  .encounter { 
    width: 14px; 
    height: 14px; 
    border-radius: 50%; 
    background: red; 
    position: absolute; 
    top: 3px; 
    right: 3px;
    box-shadow: 0 0 6px red;
  }
  
  #log { 
    background: rgba(34, 34, 34, 0.9); 
    padding: 10px; 
    min-height: 60px; 
    margin-top: 20px; 
    border-radius: 6px;
    backdrop-filter: blur(5px);
  }
  
  #restart-btn, #end-turn-btn { 
    margin-top: 15px; 
    padding: 8px 16px; 
    border: none; 
    border-radius: 6px; 
    background: gold; 
    color: #111; 
    font-weight: bold; 
    cursor: pointer;
    transition: all 0.2s;
  }
  #restart-btn:hover, #end-turn-btn:hover { background: orange; transform: scale(1.05); }
  
  #hud { 
    margin: 10px; 
    font-weight: bold;
    background: rgba(17, 17, 17, 0.8);
    padding: 10px;
    border-radius: 6px;
    backdrop-filter: blur(5px);
  }
  
  #legend {
    background: rgba(34, 34, 34, 0.9);
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    font-size: 0.9em;
    backdrop-filter: blur(5px);
  }
  
  .legend-item {
    display: inline-block;
    margin: 0 15px;
  }
  
  .legend-icon {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
  }
  
  /* Tooltip styles */
  .tooltip {
    position: relative;
    cursor: help;
  }
  
  .tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px;
    border-radius: 4px;
    white-space: nowrap;
    font-size: 0.8em;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 1000;
  }
  
  .tooltip:hover::after {
    opacity: 1;
  }
</style>
</head>
<body>
<div id="game">
  <h1>Shadows in the Deck</h1>
  <div id="hud">
    Coins: <span id="coins">0</span> | 
    Fragments: <span id="frags">0</span> | 
    Cruxflare Cards Left: <span id="crux-remaining">0</span>
  </div>
  
  <div id="legend">
    <div class="legend-item">
      <span class="legend-icon" style="background: cyan; box-shadow: 0 0 5px cyan;"></span>You
    </div>
    <div class="legend-item">
      <span class="legend-icon" style="background: gold; box-shadow: 0 0 5px gold;"></span>Fragment
    </div>
    <div class="legend-item">
      <span class="legend-icon" style="background: red; box-shadow: 0 0 5px red;"></span>Encounter
    </div>
  </div>

  <h2>Market</h2>
  <div id="market"></div>

  <h2>Your Hand</h2>
  <div id="player-hand"></div>

  <button id="end-turn-btn" onclick="endTurn()">End Turn</button>

  <h2>Dream Map</h2>
  <div id="map"></div>

  <div id="log">Welcome to the game!</div>
  <button id="restart-btn" style="display:none;" onclick="restartGame()">Restart Game</button>
</div>

<script>
let marketDeck, playerDeck, discardPile, playerHand, marketRow, mapNodes, playerPos, fragmentPositions, fragmentsCollected, totalFragments, cruxflareDeck, coins, encounterPositions;

function setupGameData(){
  marketDeck = [
    { name:"Focus +2", cost: 3, tooltip: "Gain 2 coins when played" },
    { name:"Move +2", cost: 4, tooltip: "Move 2 spaces on the map" },
    { name:"Fragment 3pts", cost: 5, tooltip: "Counts as 3 fragments when collected" },
    { name:"Shadow Blocker", cost: 4, tooltip: "Protects against some Cruxflare effects" },
    { name:"Focus +3", cost: 5, tooltip: "Gain 3 coins when played" },
    { name:"Move +3", cost: 6, tooltip: "Move 3 spaces on the map" },
    { name:"Swift Step", cost: 3, tooltip: "Move 1 space, skip encounters" },
    { name:"Dream Sight", cost: 4, tooltip: "Look at top Cruxflare card" },
    { name:"Focus +4", cost: 7, tooltip: "Gain 4 coins when played" },
    { name:"Ethereal Leap", cost: 5, tooltip: "Move to any adjacent fragment" }
  ];
  
  playerDeck = ["Focus +1","Focus +1","Focus +1","Focus +1","Focus +1","Focus +1","Focus +1","Move +1","Move +1","Move +1"];
  discardPile = [];
  playerHand = [];
  marketRow = [];
  mapNodes = 12; // Doubled from 6
  playerPos = 0;
  fragmentPositions = [3, 5, 7, 9, 11]; // More fragments for longer map
  fragmentsCollected = 0;
  totalFragments = fragmentPositions.length;
  encounterPositions = [2, 4, 6, 8, 10]; // More encounters
  
  // Doubled Cruxflare deck to maintain tension
  cruxflareDeck = [
    "Shadow Surge: Add a dead card to discard.",
    "Corruption Pulse: Remove cheapest market card.",
    "Dream Collapse: Lose a node on the map.",
    "Sudden Eclipse: Discard a random card from hand.",
    "Void Whisper: Lose 2 coins.",
    "Time Fracture: Skip next card draw.",
    "Shadow Surge: Add a dead card to discard.",
    "Corruption Pulse: Remove cheapest market card.", 
    "Dream Collapse: Lose a node on the map.",
    "Sudden Eclipse: Discard a random card from hand.",
    "Memory Drain: Shuffle a card from hand into deck.",
    "Reality Shift: Rearrange fragment positions.",
    "Shadow Surge: Add a dead card to discard.",
    "Final Darkness: Game ends in 2 turns."
  ];
  
  coins = 3; // Start with more coins for longer game
  updateHUD();
}

function initGame(){
  setupGameData();
  document.body.classList.remove('danger-mode');
  document.getElementById('restart-btn').style.display = 'none';
  for (let i=0; i<5; i++) { drawMarketCard(); }
  renderMarket();
  drawHand();
  renderHand();
  renderMap();
  updateMistOverlay();
}

function drawMarketCard(){
  if(marketDeck.length>0){
    marketRow.push(marketDeck.shift());
  }
}

function drawHand(){
  while(playerHand.length < 5 && playerDeck.length>0){
    playerHand.push(playerDeck.shift());
  }
  if(playerDeck.length===0 && discardPile.length>0){
    playerDeck = [...discardPile];
    discardPile = [];
    // Shuffle playerDeck
    for(let i = playerDeck.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [playerDeck[i], playerDeck[j]] = [playerDeck[j], playerDeck[i]];
    }
  }
}

function renderMarket(){
  let m = document.getElementById('market');
  m.innerHTML = '';
  marketRow.forEach((cardObj, i)=>{
    let el = document.createElement('div');
    el.className = 'card tooltip';
    el.setAttribute('data-tooltip', cardObj.tooltip);
    el.innerHTML = `<div>${cardObj.name}</div><div class='cost'>Cost: ${cardObj.cost}</div>`;
    el.onclick = ()=>{
      if(coins >= cardObj.cost){
        coins -= cardObj.cost;
        logMsg(`Bought ${cardObj.name}`);
        discardPile.push(cardObj.name);
        marketRow.splice(i,1);
        drawMarketCard();
        renderMarket();
        updateHUD();
      } else {
        logMsg(`Not enough coins to buy ${cardObj.name}`);
      }
    };
    m.appendChild(el);
  });
}

function renderHand(){
  let h = document.getElementById('player-hand');
  h.innerHTML = '';
  playerHand.forEach((card, i)=>{
    let el = document.createElement('div');
    el.className = 'card tooltip';
    
    // Add tooltips for hand cards
    let tooltip = "Basic card";
    if(card.includes('Focus')) tooltip = `Gain ${card.replace(/\D/g,'')} coins when played`;
    if(card.includes('Move')) tooltip = `Move ${card.replace(/\D/g,'')} spaces on the map`;
    el.setAttribute('data-tooltip', tooltip);
    
    el.textContent = card;
    el.onclick = ()=>{
      playCard(card, i);
    };
    h.appendChild(el);
  });
}

function playCard(card, index){
  if(card.includes('Move')){
    movePlayer(parseInt(card.replace(/\D/g,'')));
  }
  if(card.includes('Focus')){
    let val = parseInt(card.replace(/\D/g,''));
    coins += val;
    updateHUD();
    logMsg(`Gained ${val} coins.`);
  }
  // Special card effects
  if(card === 'Swift Step'){
    movePlayer(1, true); // Skip encounters
  }
  if(card === 'Dream Sight' && cruxflareDeck.length > 0){
    logMsg(`Next Cruxflare: ${cruxflareDeck[0]}`);
  }
  
  discardPile.push(card);
  playerHand.splice(index,1);
  renderHand();
}

function renderMap(){
  let map = document.getElementById('map');
  map.innerHTML = '';
  for(let i=0; i<mapNodes; i++){
    let node = document.createElement('div');
    node.className = 'node';
    node.title = `Node ${i}`;
    
    if(fragmentPositions.includes(i)){
      let f = document.createElement('div');
      f.className = 'fragment';
      node.appendChild(f);
      node.title += ' - Contains Fragment';
    }
    if(encounterPositions.includes(i)){
      let e = document.createElement('div');
      e.className = 'encounter';
      node.appendChild(e);
      node.title += ' - Encounter Zone';
    }
    if(i===playerPos){
      let p = document.createElement('div');
      p.className = 'player';
      node.appendChild(p);
      node.title += ' - Your Location';
    }
    map.appendChild(node);
  }
}

function movePlayer(steps, skipEncounters = false){
  playerPos = Math.min(playerPos + steps, mapNodes-1);
  
  if(fragmentPositions.includes(playerPos)){
    fragmentsCollected++;
    fragmentPositions = fragmentPositions.filter(pos => pos !== playerPos);
    updateHUD();
    logMsg(`Collected a fragment! Total: ${fragmentsCollected}`);
    if(fragmentsCollected >= totalFragments){
      logMsg(`You collected all fragments! You win!`);
      endGame();
      return;
    }
  }
  
  if(encounterPositions.includes(playerPos) && !skipEncounters){
    triggerEncounter();
  }
  
  renderMap();
}

function triggerEncounter(){
  let roll = Math.random();
  if(roll < 0.6){
    let gain = Math.ceil(Math.random()*3) + 1;
    coins += gain;
    logMsg(`Encounter: Found treasure! +${gain} coins.`);
  } else {
    let loss = Math.ceil(Math.random()*2);
    coins = Math.max(0, coins - loss);
    logMsg(`Encounter: Shadow drains you. -${loss} coins.`);
  }
  updateHUD();
}

function updateHUD(){
  document.getElementById('coins').textContent = coins;
  document.getElementById('frags').textContent = fragmentsCollected;
  document.getElementById('crux-remaining').textContent = cruxflareDeck.length;
  updateMistOverlay();
}

function updateMistOverlay(){
  // Switch to danger mode when halfway through Cruxflare deck
  if(cruxflareDeck.length <= 7){
    document.body.classList.add('danger-mode');
  }
}

function logMsg(msg){
  document.getElementById('log').textContent = msg;
}

function endTurn(){
  if(cruxflareDeck.length > 0){
    let event = cruxflareDeck.shift();
    logMsg(`Cruxflare: ${event}`);
    resolveCruxflare(event);
  } else {
    logMsg(`The dream collapses! You collected ${fragmentsCollected}/${totalFragments} fragments.`);
    endGame();
  }
  drawHand();
  renderHand();
  updateHUD();
}

function resolveCruxflare(event){
  if(event.includes('dead card')){
    discardPile.push("Shadow (dead)");
  }
  if(event.includes('Remove cheapest')){
    if(marketRow.length > 0){
      marketRow.sort((a,b) => a.cost - b.cost);
      marketRow.shift();
      drawMarketCard();
      renderMarket();
    }
  }
  if(event.includes('Lose a node') && mapNodes > 3){
    mapNodes -= 1;
    if(playerPos >= mapNodes) playerPos = mapNodes - 1;
    fragmentPositions = fragmentPositions.filter(pos => pos < mapNodes);
    encounterPositions = encounterPositions.filter(pos => pos < mapNodes);
    renderMap();
  }
  if(event.includes('Discard a random') && playerHand.length > 0){
    let rand = Math.floor(Math.random() * playerHand.length);
    let discarded = playerHand.splice(rand, 1)[0];
    discardPile.push(discarded);
    logMsg(`Lost ${discarded} from hand.`);
    renderHand();
  }
  if(event.includes('Lose 2 coins')){
    coins = Math.max(0, coins - 2);
  }
  if(event.includes('Final Darkness')){
    setTimeout(() => {
      logMsg(`Final darkness consumes the dream! Final score: ${fragmentsCollected}/${totalFragments} fragments.`);
      endGame();
    }, 3000);
  }
}

function endGame(){
  document.getElementById('market').innerHTML = '';
  document.getElementById('player-hand').innerHTML = '';
  document.getElementById('map').innerHTML = '';
  document.getElementById('restart-btn').style.display = 'inline-block';
  document.getElementById('end-turn-btn').style.display = 'none';
}

function restartGame(){
  initGame();
  logMsg('Welcome to the game!');
  document.getElementById('end-turn-btn').style.display = 'inline-block';
}

initGame();
</script>
</body>
</html>
